<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://getbootstrap.com/docs/5.3/assets/css/docs.css"
      rel="stylesheet"
    />
    <title>DUUI-Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
  </head>
  <body class="p-3 m-0 border-0 m-0 border-3 ">
    <nav class="rounded navbar navbar-expand-xl bg-body-tertiary m-4">
      <div class="container-fluid">
        <h2 class="navbar-brand">DUUI-Monitor</h2>
      </div>
    </nav>
    <!-- Example Code -->

    <div class="container-lg bg-body-tertiary p-2 rounded gap-2">
      <div class="container row m-2 gap-2 p-2">
        <div class="card p-1 col-5" aria-hidden="true">
          <div class="card-body">
            <h4 class="card-header" id="pipeline-name">
            </h4>
            <table class="card-text table table-hover">
              <tbody>
                <tr>
                  <td>#workers:</td>
                  <td id="pipeline-workers"></td>
                </tr>
                <tr>
                  <td>#documents:</td>
                  <td id="pipeline-documents"></td>
                </tr>
                <tr>
                  <td>duration:</td>
                  <td id="pipeline-duration"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <hr class="divider">
      <div class="row row-col-3" id="document_measurements" >
        <!-- <div class="col-xxl-6">
          <div class="accordion accordion-flush" id="accordionFlushExample">
            <div class="accordion-item rounded">
              <h4 class="accordion-header">
                <div
                  class="accordion-button collapsed rounded text-light bg-body-secondary mx-auto document-name"
                  data-bs-toggle="collapse"
                  data-bs-target="#flush-{document-name}"
                  aria-expanded="false"
                  aria-controls="flush-{document-name}"
                >
                  ParallelTest-1
                </div>
              </h4>
              <div
                id="flush-{document-name}"
                class="accordion-collapse collapse show"
                data-bs-parent="#accordionFlushExample"
              >
              <div class="card" aria-hidden="true">
                <div class="card-body">
                  <h4 class="card-header document-name">
                    ParallelTest-1
                  </h4>
                  <a class="card-title fw-lighter text-reset document-title">
                    C:/davet/projects/GerParCor/191042.xmi.gz
                  </a>
                  <div class="card-text">
                    <table class="table table-hover col-lg-4">
                      <thead>
                        <tr>
                          <th scope="col">Component</th>
                          <th scope="col">Scale</th>
                          <th scope="col">Duration: Url retrieval</th>
                          <th scope="col">Duration: Serialization</th>
                          <th scope="col">Duration: Deserialization</th>
                          <th scope="col">Duration: Annotator</th>
                        </tr>
                      </thead>
                      <tbody id="{document-name}-document-measurements">
                        <tr>
                          <td>[] => [Token]</td>
                          <td>3</td>
                          <td>38 sec</td>
                          <td>38 sec</td>
                          <td>38 sec</td>
                          <td>4 min</td>
                        </tr>
                        <tr>
                          <td>[] => [Token]</td>
                          <td>3</td>
                          <td>38 sec</td>
                          <td>38 sec</td>
                          <td>38 sec</td>
                          <td>4 min</td>
                        </tr>
                        <tr>
                          <td>[] => [Token]</td>
                          <td>3</td>
                          <td>38 sec</td>
                          <td>38 sec</td>
                          <td>38 sec</td>
                          <td>4 min</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div 
                  class="container img-thumbnail mx-auto bg-body-primary card-img-bottom vstack"
                  id="{document-name}-graph"  
                >
                  <svg class="mx-auto bg-primary" height="180" width="500"><polyline points="0,40 40,40 40,80 80,80 80,120 120,120 120,160" style="fill:white;stroke:red;stroke-width:4" /></svg>
                  <figcaption class="mx-auto figure-caption">Time to produce image: 34sec</figcaption>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div> -->
      </div>

    <!-- End Example Code -->
  </body>
  <script defer>
    const monitor = new WebSocket("ws://localhost:8086/v1/updates");
    let pipeline_set = false;
    const document_measurements = document.getElementById("document_measurements")

    addEventListener("beforeunload", (event) => {monitor.close()});

    monitor.onmessage = async (msg) => {
      let update = JSON.parse(msg.data)
      console.log(update)
      if (update["pipeline"] === null 
          && update["document"] === null 
          && update["document_table"] === null
          && update["graph"] === null)
        return;

      console.log(update)

      if (update["pipeline"] !== null) {
        let pipeline = JSON.parse(update["pipeline"])
        let name = document.getElementById("pipeline-name")
        if (name !== null && pipeline["name"] !== null) 
          name.innerText = pipeline["name"]

        let workers = document.getElementById("pipeline-workers")
        if (workers !== null && pipeline["workers"] !== null) 
          workers.innerText = pipeline["workers"]

        let document_count = document.getElementById("pipeline-documents")
        if (document_count !== null && pipeline["document_count"] !== null) 
          document_count.innerText = pipeline["document_count"]

        let duration = document.getElementById("pipeline-duration")
        if (duration !== null && pipeline["duration"] !== null) 
          duration.innerText = pipeline["duration"]
      } 
      
      if (update["document"] !== null) {
        let doc = JSON.parse(update["document"])
        let card = document.getElementById(doc["name"])
        if (card === null) {
          document_measurements.innerHTML += doc["body"].trim()
        }
      }

      if (update["document_table"] !== null) {
        let doc = JSON.parse(update["document_table"])
        let tablebody = document.getElementById(`${doc["name"]}-document-table`)
        if (tablebody !== null && doc["measurement"] !== null) {
          tablebody.innerHTML += doc["measurement"].trim()
        }
      }

      if (update["graph"] !== null) {
        let graph = JSON.parse(update["graph"])
        let bodyhtml = document.getElementById(`${graph["name"]}-graph`) 
        if (bodyhtml !== null) {
          bodyhtml.innerHTML = graph["body"].trim()
        }
      }
    };
  </script>
</html>